/*
 * WBOX GDI Text Rendering Implementation
 * Includes built-in 8x16 bitmap font
 */
#include "gdi_text.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* Built-in font dimensions */
#define FONT_WIDTH  8
#define FONT_HEIGHT 16

/*
 * Built-in 8x16 bitmap font (ASCII 32-127)
 * Each character is 16 bytes (16 rows of 8 pixels)
 */
static const uint8_t builtin_font_data[96][16] = {
    /* 32 ' ' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 33 '!' */ {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 34 '"' */ {0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 35 '#' */ {0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00},
    /* 36 '$' */ {0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00},
    /* 37 '%' */ {0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00},
    /* 38 '&' */ {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 39 ''' */ {0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 40 '(' */ {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
    /* 41 ')' */ {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
    /* 42 '*' */ {0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 43 '+' */ {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 44 ',' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00},
    /* 45 '-' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 46 '.' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 47 '/' */ {0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00},
    /* 48 '0' */ {0x00,0x00,0x38,0x6C,0xC6,0xC6,0xD6,0xD6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00},
    /* 49 '1' */ {0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    /* 50 '2' */ {0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* 51 '3' */ {0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 52 '4' */ {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    /* 53 '5' */ {0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 54 '6' */ {0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 55 '7' */ {0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    /* 56 '8' */ {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 57 '9' */ {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00},
    /* 58 ':' */ {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    /* 59 ';' */ {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    /* 60 '<' */ {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    /* 61 '=' */ {0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 62 '>' */ {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    /* 63 '?' */ {0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 64 '@' */ {0x00,0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00},
    /* 65 'A' */ {0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 66 'B' */ {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00},
    /* 67 'C' */ {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* 68 'D' */ {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
    /* 69 'E' */ {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* 70 'F' */ {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 71 'G' */ {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00},
    /* 72 'H' */ {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 73 'I' */ {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 74 'J' */ {0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
    /* 75 'K' */ {0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 76 'L' */ {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* 77 'M' */ {0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 78 'N' */ {0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 79 'O' */ {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 80 'P' */ {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 81 'Q' */ {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00},
    /* 82 'R' */ {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 83 'S' */ {0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 84 'T' */ {0x00,0x00,0x7E,0x7E,0x5A,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 85 'U' */ {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 86 'V' */ {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00},
    /* 87 'W' */ {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00},
    /* 88 'X' */ {0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 89 'Y' */ {0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 90 'Z' */ {0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* 91 '[' */ {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    /* 92 '\' */ {0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00},
    /* 93 ']' */ {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    /* 94 '^' */ {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 95 '_' */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    /* 96 '`' */ {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 97 'a' */ {0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 98 'b' */ {0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    /* 99 'c' */ {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 100 'd' */ {0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 101 'e' */ {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 102 'f' */ {0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 103 'g' */ {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00},
    /* 104 'h' */ {0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 105 'i' */ {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 106 'j' */ {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00},
    /* 107 'k' */ {0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 108 'l' */ {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 109 'm' */ {0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00},
    /* 110 'n' */ {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    /* 111 'o' */ {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 112 'p' */ {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00},
    /* 113 'q' */ {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00},
    /* 114 'r' */ {0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 115 's' */ {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 116 't' */ {0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00},
    /* 117 'u' */ {0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 118 'v' */ {0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00,0x00,0x00,0x00},
    /* 119 'w' */ {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00},
    /* 120 'x' */ {0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00},
    /* 121 'y' */ {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00},
    /* 122 'z' */ {0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* 123 '{' */ {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    /* 124 '|' */ {0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 125 '}' */ {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    /* 126 '~' */ {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 127 DEL */ {0x00,0x00,0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xC6,0xFE,0x00,0x00,0x00,0x00,0x00},
};

/* Get built-in font dimensions */
int gdi_builtin_font_char_width(void)
{
    return FONT_WIDTH;
}

int gdi_builtin_font_char_height(void)
{
    return FONT_HEIGHT;
}

/* Get glyph data for a character */
const uint8_t *gdi_builtin_font_get_glyph(int codepoint)
{
    if (codepoint >= 32 && codepoint < 128) {
        return builtin_font_data[codepoint - 32];
    }
    /* Return space for unknown characters */
    return builtin_font_data[0];
}

/* Draw a single character */
static void draw_char(gdi_dc_t *dc, int x, int y, uint16_t ch, uint32_t fg_color, uint32_t bg_color, bool opaque)
{
    const uint8_t *glyph = gdi_builtin_font_get_glyph(ch);

    for (int row = 0; row < FONT_HEIGHT; row++) {
        int py = y + row;
        if (py < 0 || py >= dc->height) continue;

        uint8_t bits = glyph[row];
        for (int col = 0; col < FONT_WIDTH; col++) {
            int px = x + col;
            if (px < 0 || px >= dc->width) continue;

            bool pixel_set = (bits & (0x80 >> col)) != 0;
            uint32_t *dst = &dc->pixels[py * (dc->pitch / 4) + px];

            if (pixel_set) {
                *dst = fg_color;
            } else if (opaque) {
                *dst = bg_color;
            }
        }
    }
}

/* Extended text output */
bool gdi_ext_text_out(gdi_dc_t *dc, int x, int y, uint32_t options,
                       const RECT *rect, const uint16_t *str, int count,
                       const int *dx)
{
    if (!dc || !dc->pixels || !str || count <= 0) return false;

    /* Apply DC origin */
    x += dc->vp_org_x - dc->win_org_x;
    y += dc->vp_org_y - dc->win_org_y;

    /* Get colors */
    uint32_t fg_color = colorref_to_argb(dc->text_color);
    uint32_t bg_color = colorref_to_argb(dc->bk_color);
    bool opaque = (dc->bk_mode == OPAQUE) || (options & ETO_OPAQUE);

    /* Fill background rectangle if ETO_OPAQUE */
    if ((options & ETO_OPAQUE) && rect) {
        for (int py = rect->top; py < rect->bottom && py < dc->height; py++) {
            if (py < 0) continue;
            for (int px = rect->left; px < rect->right && px < dc->width; px++) {
                if (px < 0) continue;
                dc->pixels[py * (dc->pitch / 4) + px] = bg_color;
            }
        }
    }

    /* Apply text alignment */
    if (dc->text_align & TA_CENTER) {
        int width = count * FONT_WIDTH;
        x -= width / 2;
    } else if (dc->text_align & TA_RIGHT) {
        int width = count * FONT_WIDTH;
        x -= width;
    }

    if (dc->text_align & TA_BOTTOM) {
        y -= FONT_HEIGHT;
    } else if (dc->text_align & TA_BASELINE) {
        y -= FONT_HEIGHT - 2;  /* Approximate baseline */
    }

    /* Draw each character */
    int cur_x = x;
    for (int i = 0; i < count; i++) {
        uint16_t ch = str[i];

        /* Skip control characters */
        if (ch < 32) continue;

        /* Check clipping if requested */
        if ((options & ETO_CLIPPED) && rect) {
            if (cur_x + FONT_WIDTH <= rect->left || cur_x >= rect->right) {
                cur_x += dx ? dx[i] : FONT_WIDTH;
                continue;
            }
        }

        draw_char(dc, cur_x, y, ch, fg_color, bg_color, opaque && !(options & ETO_OPAQUE));

        cur_x += dx ? dx[i] : FONT_WIDTH;
    }

    /* Update current position if TA_UPDATECP */
    if (dc->text_align & TA_UPDATECP) {
        dc->cur_x = cur_x - (dc->vp_org_x - dc->win_org_x);
        dc->cur_y = y - (dc->vp_org_y - dc->win_org_y);
    }

    dc->dirty = true;
    return true;
}

/* Get text extent */
bool gdi_get_text_extent(gdi_dc_t *dc, const uint16_t *str, int count, SIZE *size)
{
    if (!dc || !size) return false;

    /* Use font dimensions if available, otherwise built-in */
    int char_width = FONT_WIDTH;
    int char_height = FONT_HEIGHT;

    if (dc->font) {
        if (dc->font->width > 0) char_width = dc->font->width;
        if (dc->font->height > 0) char_height = abs(dc->font->height);
    }

    size->cx = count * char_width;
    size->cy = char_height;

    return true;
}

/* Get text extent with extra info */
bool gdi_get_text_extent_ex(gdi_dc_t *dc, const uint16_t *str, int count,
                             int max_extent, int *fit, int *dx, SIZE *size)
{
    if (!dc) return false;

    int char_width = FONT_WIDTH;
    int char_height = FONT_HEIGHT;

    if (dc->font) {
        if (dc->font->width > 0) char_width = dc->font->width;
        if (dc->font->height > 0) char_height = abs(dc->font->height);
    }

    int total_width = 0;
    int chars_fit = 0;

    for (int i = 0; i < count; i++) {
        int new_width = total_width + char_width;
        if (max_extent > 0 && new_width > max_extent) {
            break;
        }
        total_width = new_width;
        chars_fit++;
        if (dx) dx[i] = total_width;
    }

    if (fit) *fit = chars_fit;
    if (size) {
        size->cx = total_width;
        size->cy = char_height;
    }

    return true;
}

/* Get character widths */
bool gdi_get_char_width(gdi_dc_t *dc, uint32_t first, uint32_t last, int *widths)
{
    if (!dc || !widths) return false;

    int char_width = FONT_WIDTH;
    if (dc->font && dc->font->width > 0) {
        char_width = dc->font->width;
    }

    for (uint32_t i = first; i <= last; i++) {
        widths[i - first] = char_width;
    }

    return true;
}

/* Get text metrics */
bool gdi_get_text_metrics(gdi_dc_t *dc, void *tm)
{
    if (!dc || !tm) return false;

    /* Fill TEXTMETRICW structure */
    /* This is a simplified version */
    struct {
        int32_t tmHeight;
        int32_t tmAscent;
        int32_t tmDescent;
        int32_t tmInternalLeading;
        int32_t tmExternalLeading;
        int32_t tmAveCharWidth;
        int32_t tmMaxCharWidth;
        int32_t tmWeight;
        int32_t tmOverhang;
        int32_t tmDigitizedAspectX;
        int32_t tmDigitizedAspectY;
        uint16_t tmFirstChar;
        uint16_t tmLastChar;
        uint16_t tmDefaultChar;
        uint16_t tmBreakChar;
        uint8_t tmItalic;
        uint8_t tmUnderlined;
        uint8_t tmStruckOut;
        uint8_t tmPitchAndFamily;
        uint8_t tmCharSet;
    } *metrics = tm;

    int height = FONT_HEIGHT;
    int width = FONT_WIDTH;

    if (dc->font) {
        if (dc->font->height > 0) height = dc->font->height;
        if (dc->font->width > 0) width = dc->font->width;
    }

    metrics->tmHeight = height;
    metrics->tmAscent = height - 2;
    metrics->tmDescent = 2;
    metrics->tmInternalLeading = 0;
    metrics->tmExternalLeading = 0;
    metrics->tmAveCharWidth = width;
    metrics->tmMaxCharWidth = width;
    metrics->tmWeight = dc->font ? dc->font->weight : 400;
    metrics->tmOverhang = 0;
    metrics->tmDigitizedAspectX = 96;
    metrics->tmDigitizedAspectY = 96;
    metrics->tmFirstChar = 32;
    metrics->tmLastChar = 127;
    metrics->tmDefaultChar = '?';
    metrics->tmBreakChar = ' ';
    metrics->tmItalic = dc->font ? dc->font->italic : 0;
    metrics->tmUnderlined = dc->font ? dc->font->underline : 0;
    metrics->tmStruckOut = dc->font ? dc->font->strikeout : 0;
    metrics->tmPitchAndFamily = dc->font ? dc->font->pitch_and_family : 0x22;
    metrics->tmCharSet = dc->font ? dc->font->char_set : 0;

    return true;
}

/* Create font */
uint32_t gdi_create_font(gdi_handle_table_t *table, int height, int width,
                          int escapement, int orientation, int weight,
                          bool italic, bool underline, bool strikeout,
                          int charset, int out_precision, int clip_precision,
                          int quality, int pitch_and_family, const char *face_name)
{
    (void)out_precision;
    (void)clip_precision;
    (void)quality;

    gdi_font_t *font = gdi_alloc_font(table);
    if (!font) return 0;

    font->height = height;
    font->width = width;
    font->escapement = escapement;
    font->orientation = orientation;
    font->weight = weight;
    font->italic = italic;
    font->underline = underline;
    font->strikeout = strikeout;
    font->char_set = charset;
    font->pitch_and_family = pitch_and_family;

    if (face_name) {
        strncpy(font->face_name, face_name, sizeof(font->face_name) - 1);
        font->face_name[sizeof(font->face_name) - 1] = '\0';
    } else {
        font->face_name[0] = '\0';
    }

    uint32_t handle = gdi_alloc_handle(table, font, GDI_OBJ_FONT);
    if (!handle) {
        gdi_free_font(table, font);
        return 0;
    }

    font->handle = handle;
    return handle;
}
